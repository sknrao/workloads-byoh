# Complete SD-Core Package Creation Workflow with Nephio

## Quick Answer to Your Question

**YES - You DO need readiness gates in the Kptfile!**

For each Interface resource (n3, n6, n4), you need **TWO** readiness gates:
1. `req.nephio.org.interface.<name>` - for Interface processing
2. `ipam.nephio.org.ipclaim.<name>` - for IP allocation

Plus one for WorkloadCluster injection.

But you do **NOT** manually write the `status.conditions` section - that's auto-generated by Nephio controllers.

## Complete Workflow: From Scratch to Deployed NADs

### Phase 1: Create Upstream Package (Management Cluster)

#### Step 1: Create Package Structure
```bash
# Create package directory
mkdir -p upf-blueprint
cd upf-blueprint
```

#### Step 2: Create Interface Resources
```yaml
# interfaces.yaml
apiVersion: req.nephio.org/v1alpha1
kind: Interface
metadata:
  name: n3
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
spec:
  networkInstance:
    name: vpc-ran
  cniType: macvlan
  attachmentType: vlan
---
apiVersion: req.nephio.org/v1alpha1
kind: Interface
metadata:
  name: n6
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
spec:
  networkInstance:
    name: vpc-internet
  cniType: macvlan
  attachmentType: vlan
---
apiVersion: req.nephio.org/v1alpha1
kind: Interface
metadata:
  name: n4
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
spec:
  networkInstance:
    name: vpc-internal
  cniType: macvlan
  attachmentType: vlan
```

#### Step 3: Create NetworkInstance Resources
```yaml
# network-instances.yaml
apiVersion: infra.nephio.org/v1alpha1
kind: NetworkInstance
metadata:
  name: vpc-ran
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
spec:
  name: vpc-ran
  pools:
  - name: n3-pool
    prefixLength: 24
---
apiVersion: infra.nephio.org/v1alpha1
kind: NetworkInstance
metadata:
  name: vpc-internet
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
spec:
  name: vpc-internet
  pools:
  - name: n6-pool
    prefixLength: 24
---
apiVersion: infra.nephio.org/v1alpha1
kind: NetworkInstance
metadata:
  name: vpc-internal
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
spec:
  name: vpc-internal
  pools:
  - name: n4-pool
    prefixLength: 24
```

#### Step 4: Create Kptfile with Readiness Gates
```yaml
# Kptfile
apiVersion: kpt.dev/v1
kind: Kptfile
metadata:
  name: upf-blueprint
  annotations:
    config.kubernetes.io/local-config: "true"
info:
  description: SD-Core UPF deployment package
  
  # CRITICAL: Define readiness gates for all Interface resources
  readinessGates:
  - conditionType: config.injection.WorkloadCluster.workload-cluster
  - conditionType: req.nephio.org.interface.n3
  - conditionType: req.nephio.org.interface.n6
  - conditionType: req.nephio.org.interface.n4
  - conditionType: ipam.nephio.org.ipclaim.n3
  - conditionType: ipam.nephio.org.ipclaim.n6
  - conditionType: ipam.nephio.org.ipclaim.n4

pipeline:
  mutators:
  - image: docker.io/nephio/interface-fn:v2.0.0
  - image: docker.io/nephio/nad-fn:v2.0.0
  
  validators:
  - image: gcr.io/kpt-fn/kubeval:v0.3.0
    configMap:
      ignore_missing_schemas: "true"
```

#### Step 5: Commit to Upstream Repository
```bash
# Initialize git if needed
git init
git add .
git commit -m "Initial UPF blueprint with Interface resources"
git push origin main
```

### Phase 2: Setup IPAM (Management Cluster)

#### Step 6: Create IP Pools
```yaml
# Apply to management cluster
kubectl apply -f - <<EOF
apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPPrefix
metadata:
  name: ran-pool
  namespace: default
spec:
  prefix: 192.168.252.0/24
  networkInstance:
    name: vpc-ran
---
apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPPrefix
metadata:
  name: internet-pool
  namespace: default
spec:
  prefix: 192.168.250.0/24
  networkInstance:
    name: vpc-internet
---
apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPPrefix
metadata:
  name: internal-pool
  namespace: default
spec:
  prefix: 10.0.0.0/24
  networkInstance:
    name: vpc-internal
EOF
```

### Phase 3: Create PackageVariant (Management Cluster)

#### Step 7: Create WorkloadCluster Resource
```yaml
kubectl apply -f - <<EOF
apiVersion: infra.nephio.org/v1alpha1
kind: WorkloadCluster
metadata:
  name: edge-cluster-1
  namespace: default
spec:
  clusterName: edge-cluster-1
  cnis:
  - macvlan
  - sriov
  masterInterface: ens3
EOF
```

#### Step 8: Create PackageVariant
```yaml
kubectl apply -f - <<EOF
apiVersion: porch.kpt.dev/v1alpha1
kind: PackageVariant
metadata:
  name: upf-edge-cluster-1
  namespace: default
spec:
  upstream:
    repo: upf-blueprints
    package: upf-blueprint
    revision: v1
  downstream:
    repo: edge-cluster-1-repo
    package: upf-edge-cluster-1
  injectors:
  - name: workload-cluster
    kind: WorkloadCluster
    resourceName: edge-cluster-1
EOF
```

### Phase 4: Monitor Package Processing

#### Step 9: Watch Package Conditions
```bash
# Watch package revision creation
kubectl get packagerevisions -n upf --watch

# Check conditions in detail
kubectl get packagerevision upf-edge-cluster-1-v1 -n upf -o yaml | yq '.status.conditions'
```

Expected progression:
```
1. Package created (Draft)
   └─ All conditions: False

2. WorkloadCluster injected
   └─ config.injection.WorkloadCluster.workload-cluster: True
   └─ Other conditions: False

3. interface-fn runs
   └─ Creates IPClaim resources
   └─ req.nephio.org.interface.n3: True
   └─ req.nephio.org.interface.n6: True
   └─ req.nephio.org.interface.n4: True
   └─ IPClaim conditions: False

4. IPAM allocates IPs
   └─ ipam.nephio.org.ipclaim.n3: True (192.168.252.3/32)
   └─ ipam.nephio.org.ipclaim.n6: True (192.168.250.3/32)
   └─ ipam.nephio.org.ipclaim.n4: True (10.0.0.3/32)

5. nad-fn runs
   └─ Generates NetworkAttachmentDefinitions
   
6. All conditions True → Package Ready
   └─ Can be PROPOSED and APPROVED
```

#### Step 10: View Generated Resources
```bash
# View package contents
kubectl get packagerevisionresources upf-edge-cluster-1-v1 -n upf -o yaml

# Look for generated IPClaims
kubectl get packagerevisionresources upf-edge-cluster-1-v1 -n upf -o yaml | grep -A 20 "kind: IPClaim"

# Look for generated NADs
kubectl get packagerevisionresources upf-edge-cluster-1-v1 -n upf -o yaml | grep -A 30 "kind: NetworkAttachmentDefinition"
```

### Phase 5: Approve and Deploy

#### Step 11: Propose Package
```bash
# Via kubectl
kubectl patch packagerevision upf-edge-cluster-1-v1 -n upf \
  --type merge \
  -p '{"spec":{"lifecycle":"proposed"}}'

# Or via kpt CLI
kpt alpha rpkg propose upf-edge-cluster-1-v1 -n upf
```

#### Step 12: Approve Package
```bash
# Via kubectl
kubectl patch packagerevision upf-edge-cluster-1-v1 -n upf \
  --type merge \
  -p '{"spec":{"lifecycle":"published"}}'

# Or via kpt CLI
kpt alpha rpkg approve upf-edge-cluster-1-v1 -n upf
```

#### Step 13: Verify Deployment to Workload Cluster
```bash
# Switch to workload cluster context
kubectl config use-context edge-cluster-1

# Check NADs deployed
kubectl get network-attachment-definitions -n upf

# Should see:
# NAME   AGE
# n3     1m
# n6     1m
# n4     1m

# View NAD details
kubectl get network-attachment-definition n3 -n upf -o yaml
```

Expected NAD output:
```yaml
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: n3
  namespace: upf
spec:
  config: |
    {
      "cniVersion": "0.3.1",
      "type": "macvlan",
      "master": "ens3",
      "mode": "bridge",
      "ipam": {
        "type": "static",
        "addresses": [
          {
            "address": "192.168.252.3/32",
            "gateway": "192.168.252.1"
          }
        ]
      }
    }
```

### Phase 6: Deploy SD-Core

#### Step 14: Deploy UPF with Helm
```bash
# Create SD-Core values referencing the NADs
cat > sdcore-values.yaml <<EOF
omec-user-plane:
  enable: true
  config:
    upf:
      access:
        resourceName: "n3"
        ipam: static
        cniPlugin: macvlan
        iface: "ens3"
        gateway: "192.168.252.1"
        ip: "192.168.252.3/32"
      core:
        resourceName: "n6"
        ipam: static
        cniPlugin: macvlan
        iface: "ens3"
        gateway: "192.168.250.1"
        ip: "192.168.250.3/32"
      enb:
        subnet: "192.168.2.0/24"
EOF

# Deploy SD-Core
helm install -n upf sdcore-5g -f sdcore-values.yaml omec/sd-core
```

#### Step 15: Verify UPF Pod Networking
```bash
# Check UPF pod
kubectl get pods -n upf -l app=upf

# View network annotations
kubectl get pod upf-0 -n upf -o jsonpath='{.metadata.annotations.k8s\.v1\.cni\.cncf\.io/network-status}' | jq .

# Exec into pod and check interfaces
kubectl exec -it -n upf upf-0 -c bessd -- ip addr

# Should see:
# eth0      - default K8s network
# net1      - n3 interface (192.168.252.3)
# net2      - n6 interface (192.168.250.3)
# net3      - n4 interface (10.0.0.3)
```

## Summary Checklist

### In Upstream Package (What You Create):
- [ ] Interface resources for n3, n6, n4
- [ ] NetworkInstance resources for each network
- [ ] Kptfile with:
  - [ ] `info.readinessGates` section (7 conditions)
  - [ ] `pipeline.mutators` (interface-fn, nad-fn)
  - [ ] NO `status` section (auto-generated)

### In Management Cluster:
- [ ] IPPrefix resources (IP pools)
- [ ] WorkloadCluster resource
- [ ] PackageVariant to instantiate package

### Automatic Processing:
- [ ] interface-fn creates IPClaim resources
- [ ] IPAM allocates IPs from pools
- [ ] nad-fn generates NADs
- [ ] All readiness gates become True

### In Workload Cluster:
- [ ] NADs deployed via ConfigSync
- [ ] SD-Core deployed via Helm
- [ ] UPF pod has multiple interfaces

## Readiness Gates Reference

For SD-Core UPF with 3 interfaces, you ALWAYS need:

```yaml
info:
  readinessGates:
  # 1 for WorkloadCluster
  - conditionType: config.injection.WorkloadCluster.workload-cluster
  
  # 3 for Interface resources (one per interface)
  - conditionType: req.nephio.org.interface.n3
  - conditionType: req.nephio.org.interface.n6
  - conditionType: req.nephio.org.interface.n4
  
  # 3 for IPClaim resources (one per interface)
  - conditionType: ipam.nephio.org.ipclaim.n3
  - conditionType: ipam.nephio.org.ipclaim.n6
  - conditionType: ipam.nephio.org.ipclaim.n4
```

**Total: 7 readiness gates** (1 + 3 + 3)

## Common Mistakes to Avoid

❌ **Don't** manually write `status.conditions` in your Kptfile
✅ **Do** define `info.readinessGates`

❌ **Don't** forget readiness gates for IPClaims
✅ **Do** include both Interface AND IPClaim conditions

❌ **Don't** try to PROPOSE package before all conditions are True
✅ **Do** wait for all conditions to turn True (watch the UI or kubectl)

❌ **Don't** forget `config.kubernetes.io/local-config: "true"` on Interface resources
✅ **Do** mark all non-deployable resources as local-config

## Quick Debugging

### Package stuck in Draft?
```bash
# Check which conditions are False
kubectl get packagerevision <n> -n upf -o jsonpath='{.status.conditions[?(@.status=="False")].type}'
```

### Interface condition not True?
```bash
# Check if Interface resource exists in package
kubectl get packagerevisionresources <n> -n upf -o yaml | grep "kind: Interface"
```

### IPClaim condition not True?
```bash
# Check IPClaim status
kubectl get packagerevisionresources <n> -n upf -o yaml | grep -A 10 "kind: IPClaim"

# Check IPAM controller
kubectl get pods -n nephio-system | grep ipam
```

### NAD not generated?
```bash
# Check if nad-fn is in pipeline
kubectl get packagerevision <n> -n upf -o jsonpath='{.spec.pipeline.mutators[*].image}'

# Should include: docker.io/nephio/nad-fn
```

This complete workflow ensures NADs are automatically generated to match SD-Core's expectations!
