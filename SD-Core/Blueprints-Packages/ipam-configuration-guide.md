# IP Allocation Configuration for Nephio with SD-Core

## Overview
This file shows how to configure IP address allocation for SD-Core using Nephio's IPAM system.

## IP Pool Configuration

First, create IPPrefix resources that define available IP pools:

```yaml
---
# ip-pools.yaml
# Define IP address pools for different networks

apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPPrefix
metadata:
  name: ran-network-pool
  namespace: default
spec:
  prefix: 192.168.252.0/24
  networkInstance:
    name: vpc-ran
  labels:
    nephio.org/purpose: ran
    nephio.org/network-type: access

---
apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPPrefix
metadata:
  name: internet-network-pool
  namespace: default
spec:
  prefix: 192.168.250.0/24
  networkInstance:
    name: vpc-internet
  labels:
    nephio.org/purpose: internet
    nephio.org/network-type: core

---
apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPPrefix
metadata:
  name: internal-network-pool
  namespace: default
spec:
  prefix: 10.0.0.0/24
  networkInstance:
    name: vpc-internal
  labels:
    nephio.org/purpose: internal
    nephio.org/network-type: signaling
```

## IPClaim Resources (Auto-Generated by interface-fn)

The interface-fn automatically creates IPClaim resources based on Interface resources.
Here's what they look like:

```yaml
---
# ipclaims.yaml
# These are created automatically - shown for reference

apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPClaim
metadata:
  name: upf.n3.v4
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
    specializer.nephio.org/owner: req.nephio.org/v1alpha1.Interface.n3
  labels:
    nephio.org/interface: n3
    nephio.org/ip-family: ipv4
spec:
  kind: network
  networkInstance:
    name: vpc-ran
  selector:
    matchLabels:
      nephio.org/purpose: ran
  prefixLength: 32
  createPrefix: false
  addressFamily: ipv4

---
apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPClaim
metadata:
  name: upf.n6.v4
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
    specializer.nephio.org/owner: req.nephio.org/v1alpha1.Interface.n6
  labels:
    nephio.org/interface: n6
    nephio.org/ip-family: ipv4
spec:
  kind: network
  networkInstance:
    name: vpc-internet
  selector:
    matchLabels:
      nephio.org/purpose: internet
  prefixLength: 32
  createPrefix: false
  addressFamily: ipv4

---
apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPClaim
metadata:
  name: upf.n4.v4
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
    specializer.nephio.org/owner: req.nephio.org/v1alpha1.Interface.n4
  labels:
    nephio.org/interface: n4
    nephio.org/ip-family: ipv4
spec:
  kind: network
  networkInstance:
    name: vpc-internal
  selector:
    matchLabels:
      nephio.org/purpose: internal
  prefixLength: 32
  createPrefix: false
  addressFamily: ipv4
```

## IPClaim Status (Populated by IPAM Controller)

After the IPAM controller allocates IPs, the status field is populated:

```yaml
apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPClaim
metadata:
  name: upf.n3.v4
  namespace: upf
spec:
  kind: network
  networkInstance:
    name: vpc-ran
  prefixLength: 32
  addressFamily: ipv4
status:
  # These fields are populated by IPAM controller
  prefix: 192.168.252.3/32
  gateway: 192.168.252.1
  allocationStatus: Allocated
  conditions:
  - type: IPClaimReady
    status: "True"
    lastTransitionTime: "2026-02-12T10:00:00Z"
    reason: AllocationSuccessful
    message: IP address allocated successfully
```

## Complete Workflow Example

### Step 1: Create IP Pools in Management Cluster

```bash
# Apply IP pool definitions
kubectl apply -f - <<EOF
apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPPrefix
metadata:
  name: ran-pool
  namespace: default
spec:
  prefix: 192.168.252.0/24
  networkInstance:
    name: vpc-ran
---
apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPPrefix
metadata:
  name: internet-pool
  namespace: default
spec:
  prefix: 192.168.250.0/24
  networkInstance:
    name: vpc-internet
---
apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPPrefix
metadata:
  name: internal-pool
  namespace: default
spec:
  prefix: 10.0.0.0/24
  networkInstance:
    name: vpc-internal
EOF
```

### Step 2: Verify IP Pools

```bash
kubectl get ipprefixes
```

Expected output:
```
NAME             PREFIX              NETWORKINSTANCE
ran-pool         192.168.252.0/24   vpc-ran
internet-pool    192.168.250.0/24   vpc-internet
internal-pool    10.0.0.0/24        vpc-internal
```

### Step 3: Create UPF Package with Interface Resources

Your package should contain Interface resources (as shown in previous examples).
When the package is processed:

1. interface-fn reads Interface resources
2. Creates IPClaim resources for each interface
3. IPAM controller sees IPClaim resources
4. Allocates IPs from matching IPPrefix pools
5. Updates IPClaim.status with allocated IP and gateway

### Step 4: Verify IP Allocation

```bash
# In the package revision
kubectl get ipclaim -n upf

# Expected output
NAME          NETWORKINSTANCE  PREFIX              STATUS
upf.n3.v4     vpc-ran         192.168.252.3/32    Allocated
upf.n6.v4     vpc-internet    192.168.250.3/32    Allocated
upf.n4.v4     vpc-internal    10.0.0.3/32         Allocated
```

### Step 5: NAD Generation

After IPs are allocated, nad-fn reads:
- Interface spec (for CNI type, master interface)
- IPClaim status (for IP address, gateway)
- WorkloadCluster spec (for master interface name)

And generates NetworkAttachmentDefinitions:

```yaml
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: n3
  namespace: upf
spec:
  config: |
    {
      "cniVersion": "0.3.1",
      "type": "macvlan",
      "master": "ens3",
      "mode": "bridge",
      "ipam": {
        "type": "static",
        "addresses": [
          {
            "address": "192.168.252.3/32",
            "gateway": "192.168.252.1"
          }
        ],
        "routes": [
          {
            "dst": "0.0.0.0/0"
          }
        ]
      }
    }
```

## Advanced IPAM Configuration

### Using Specific IP Addresses

If you want to assign specific IPs (not from a pool):

```yaml
apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPClaim
metadata:
  name: upf-n3-fixed-ip
  namespace: upf
spec:
  kind: network
  networkInstance:
    name: vpc-ran
  prefix: 192.168.252.10/32  # Request specific IP
  gateway: 192.168.252.1
  createPrefix: true  # Create if doesn't exist
```

### Dual-Stack Configuration

For both IPv4 and IPv6:

```yaml
# IPv4 Claim
apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPClaim
metadata:
  name: upf.n3.v4
  namespace: upf
spec:
  kind: network
  networkInstance:
    name: vpc-ran
  addressFamily: ipv4
  prefixLength: 32

---
# IPv6 Claim
apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPClaim
metadata:
  name: upf.n3.v6
  namespace: upf
spec:
  kind: network
  networkInstance:
    name: vpc-ran
  addressFamily: ipv6
  prefixLength: 128
```

And corresponding IPv6 pool:

```yaml
apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPPrefix
metadata:
  name: ran-pool-v6
  namespace: default
spec:
  prefix: fd00:192:168:252::/64
  networkInstance:
    name: vpc-ran
  labels:
    nephio.org/ip-family: ipv6
```

## Troubleshooting IP Allocation

### IPClaim Not Getting Allocated

1. Check IPAM controller status:
```bash
kubectl get pods -n nephio-system | grep ipam
kubectl logs -n nephio-system <ipam-controller-pod>
```

2. Verify IPPrefix exists for the networkInstance:
```bash
kubectl get ipprefixes -A
```

3. Check IPClaim conditions:
```bash
kubectl get ipclaim <name> -n <namespace> -o yaml | grep -A 10 conditions
```

### IP Address Conflicts

If you see allocation failures:

```bash
# List all allocated IPs
kubectl get ipclaim -A -o jsonpath='{range .items[*]}{.status.prefix}{"\n"}{end}'

# Check IPPrefix capacity
kubectl get ipprefix <name> -o yaml
```

## Best Practices

1. **Centralized Pool Management**: Define all IPPrefix resources in a central management repository

2. **Namespace Strategy**: Use consistent namespace strategy
   - IPPrefix: Usually in `default` or dedicated `ipam` namespace
   - IPClaim: In workload namespace (`upf`, `amf`, etc.)

3. **Labeling**: Use consistent labels for filtering and selection
   ```yaml
   labels:
     nephio.org/purpose: ran|internet|internal
     nephio.org/nf-type: upf|amf|smf
     nephio.org/site: edge-1|regional-1
   ```

4. **Pool Sizing**: Plan IP pools with growth in mind
   - UPF typically needs: N3 (/32), N6 (/32), N4 (/32), N9 (/32 if multi-UPF)
   - Leave room for scaling (multiple UPF instances)

5. **Documentation**: Document IP allocation strategy in your repository

## Integration with SD-Core

After NADs are generated, SD-Core Helm values should reference the allocated IPs:

```yaml
omec-user-plane:
  config:
    upf:
      access:
        # These values come from IPClaim status
        ip: "192.168.252.3/32"
        gateway: "192.168.252.1"
      core:
        ip: "192.168.250.3/32"
        gateway: "192.168.250.1"
      cfgFiles:
        upf.json:
          gtpu:
            - addr: "192.168.252.3"  # N3 address
          pfcp:
            - addr: "10.0.0.3"       # N4 address
```

## Summary

The IP allocation flow:
1. Create IPPrefix resources (pools)
2. Create Interface resources
3. interface-fn generates IPClaim resources
4. IPAM controller allocates IPs from pools
5. IPClaim.status populated with allocated IP
6. nad-fn reads IPClaim.status to generate NADs
7. SD-Core uses NAD for pod networking
