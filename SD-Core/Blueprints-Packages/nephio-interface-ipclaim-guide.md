# Nephio Interface and IPClaim Guide for SD-Core

## Overview

This guide explains how to create Nephio `Interface` and `IPClaim` resources that work with the `nad-fn` KRM function to automatically generate NetworkAttachmentDefinitions (NADs) for SD-Core deployment.

## Understanding the Nephio NAD Generation Flow

```
┌──────────────┐     ┌─────────────┐     ┌──────────────┐
│  Interface   │────>│interface-fn │────>│   IPClaim    │
│   Resource   │     │(KRM Function│     │   Resource   │
└──────────────┘     └─────────────┘     └──────────────┘
                            │                      │
                            ▼                      ▼
                    ┌────────────────────────────────┐
                    │ VLANClaim (if VLAN specified)  │
                    └────────────────────────────────┘
                            │
                            ▼
                    ┌────────────────┐
                    │       NAD      │
                    │  (Generated by │
                    │     nad-fn)    │
                    └────────────────┘
```

### The Process

1. **Interface Resource**: You create this to declare your network interface requirements
2. **interface-fn**: Nephio KRM function that reads Interface resources and creates:
   - IPClaim resources for IP address allocation
   - VLANClaim resources (if VLAN is specified)
   - NAD resources (NetworkAttachmentDefinitions)
3. **IPClaim**: Request for IP address allocation from IPAM controller
4. **nad-fn**: Reads the IPClaim status and Interface spec to generate final NAD

## API References

### Interface Resource (req.nephio.org/v1alpha1)

The Interface resource describes network interface requirements for a workload.

**Key Fields:**
- `networkInstance`: Reference to a NetworkInstance resource
- `cniType`: CNI plugin type (macvlan, sriov, ipvlan, etc.)
- `attachmentType`: How interface attaches (vlan, routed, etc.)
- `ipFamilyPolicy`: IPv4, IPv6, or dual-stack

### IPClaim Resource (ipam.resource.nephio.org/v1alpha1)

The IPClaim resource requests IP address allocation.

**Key Fields:**
- `networkInstance`: Network pool to allocate from
- `prefixLength`: Requested prefix length
- `createPrefix`: Whether to create a new prefix
- `kind`: Type of IP claim (network, loopback, etc.)

## SD-Core Network Requirements

SD-Core UPF requires three separate network interfaces:

| Interface | 5G Name | Purpose | Typical Subnet |
|-----------|---------|---------|----------------|
| Access | N3 | UPF ↔ RAN (gNB) | 192.168.252.0/24 |
| Core | N6 | UPF ↔ Data Network | 192.168.250.0/24 |
| ENB Subnet | - | Routing to RAN subnet | 192.168.2.0/24 |

## Creating Interface Resources for SD-Core

### 1. Access Network Interface (N3)

This interface connects the UPF to the RAN (gNB/eNB).

```yaml
apiVersion: req.nephio.org/v1alpha1
kind: Interface
metadata:
  name: upf-n3
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
    specializer.nephio.org/owner: upf-deployment
spec:
  networkInstance:
    name: access-network
  cniType: macvlan
  attachmentType: vlan
```

**Corresponding IPClaim** (created automatically by interface-fn):

```yaml
apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPClaim
metadata:
  name: upf-n3-ipv4
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
    specializer.nephio.org/owner: upf-deployment
spec:
  kind: network
  networkInstance:
    name: access-network
  prefixLength: 24
status:
  prefix: 192.168.252.3/24
  gateway: 192.168.252.1
```

### 2. Core Network Interface (N6)

This interface connects the UPF to the Data Network/Internet.

```yaml
apiVersion: req.nephio.org/v1alpha1
kind: Interface
metadata:
  name: upf-n6
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
    specializer.nephio.org/owner: upf-deployment
spec:
  networkInstance:
    name: core-network
  cniType: macvlan
  attachmentType: vlan
```

**Corresponding IPClaim**:

```yaml
apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPClaim
metadata:
  name: upf-n6-ipv4
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
    specializer.nephio.org/owner: upf-deployment
spec:
  kind: network
  networkInstance:
    name: core-network
  prefixLength: 24
status:
  prefix: 192.168.250.3/24
  gateway: 192.168.250.1
```

### 3. ENB Subnet Interface

For routing to the RAN subnet:

```yaml
apiVersion: req.nephio.org/v1alpha1
kind: Interface
metadata:
  name: upf-enb
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
    specializer.nephio.org/owner: upf-deployment
spec:
  networkInstance:
    name: enb-network
  cniType: macvlan
  attachmentType: vlan
```

**Corresponding IPClaim**:

```yaml
apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPClaim
metadata:
  name: upf-enb-ipv4
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
    specializer.nephio.org/owner: upf-deployment
spec:
  kind: network
  networkInstance:
    name: enb-network
  prefixLength: 24
status:
  prefix: 192.168.2.3/24
  gateway: 192.168.2.1
```

## Complete Example: UPF Package with All Interfaces

This is how your UPF package should look with all Interface resources:

```yaml
---
# upf-interfaces.yaml
# Interface declarations for SD-Core UPF

apiVersion: req.nephio.org/v1alpha1
kind: Interface
metadata:
  name: n3
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
    specializer.nephio.org/owner: req.nephio.org/v1alpha1.NFDeployment.upf
  labels:
    nephio.org/site: edge-1
spec:
  networkInstance:
    name: vpc-ran
  cniType: macvlan
  attachmentType: vlan
---
apiVersion: req.nephio.org/v1alpha1
kind: Interface
metadata:
  name: n6
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
    specializer.nephio.org/owner: req.nephio.org/v1alpha1.NFDeployment.upf
  labels:
    nephio.org/site: edge-1
spec:
  networkInstance:
    name: vpc-internet
  cniType: macvlan
  attachmentType: vlan
---
apiVersion: req.nephio.org/v1alpha1
kind: Interface
metadata:
  name: n4
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
    specializer.nephio.org/owner: req.nephio.org/v1alpha1.NFDeployment.upf
  labels:
    nephio.org/site: edge-1
spec:
  networkInstance:
    name: vpc-internal
  cniType: macvlan
  attachmentType: vlan
```

## NetworkInstance Resources

You also need to define NetworkInstance resources that the Interfaces reference:

```yaml
---
# network-instances.yaml

apiVersion: infra.nephio.org/v1alpha1
kind: NetworkInstance
metadata:
  name: vpc-ran
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
spec:
  name: vpc-ran
  interfaces:
  - kind: bridgedomain
  - kind: interface
    selector:
      matchLabels:
        nephio.org/purpose: n3
  pools:
  - name: n3-pool
    prefixLength: 24
---
apiVersion: infra.nephio.org/v1alpha1
kind: NetworkInstance
metadata:
  name: vpc-internet
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
spec:
  name: vpc-internet
  interfaces:
  - kind: bridgedomain
  - kind: interface
    selector:
      matchLabels:
        nephio.org/purpose: n6
  pools:
  - name: n6-pool
    prefixLength: 24
---
apiVersion: infra.nephio.org/v1alpha1
kind: NetworkInstance
metadata:
  name: vpc-internal
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
spec:
  name: vpc-internal
  interfaces:
  - kind: bridgedomain
  - kind: interface
    selector:
      matchLabels:
        nephio.org/purpose: n4
  pools:
  - name: n4-pool
    prefixLength: 24
```

## WorkloadCluster Resource

The interface-fn requires a WorkloadCluster resource to provide cluster-specific information:

```yaml
apiVersion: infra.nephio.org/v1alpha1
kind: WorkloadCluster
metadata:
  name: edge-1
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
spec:
  clusterName: edge-1
  cnis:
  - macvlan
  - sriov
  masterInterface: eth0
```

## Advanced Configurations

### Using SR-IOV Instead of MacVLAN

```yaml
apiVersion: req.nephio.org/v1alpha1
kind: Interface
metadata:
  name: n3-sriov
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
spec:
  networkInstance:
    name: vpc-ran
  cniType: sriov
  attachmentType: vlan
```

### Specifying VLAN ID

```yaml
apiVersion: req.nephio.org/v1alpha1
kind: Interface
metadata:
  name: n3-with-vlan
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
spec:
  networkInstance:
    name: vpc-ran
  cniType: macvlan
  attachmentType: vlan
  vlanID: 100  # Specific VLAN ID
```

### IPv6 Configuration

```yaml
apiVersion: req.nephio.org/v1alpha1
kind: Interface
metadata:
  name: n3-ipv6
  namespace: upf
  annotations:
    config.kubernetes.io/local-config: "true"
spec:
  networkInstance:
    name: vpc-ran
  cniType: macvlan
  attachmentType: vlan
  ipFamilyPolicy: DualStack
```

Corresponding IPClaim for IPv6:

```yaml
apiVersion: ipam.resource.nephio.org/v1alpha1
kind: IPClaim
metadata:
  name: n3-ipv6
  namespace: upf
spec:
  kind: network
  networkInstance:
    name: vpc-ran
  prefixLength: 64
  addressFamily: ipv6
```

## How NADs Are Generated

Once you have Interface and IPClaim resources with proper status, the `nad-fn` generates NADs:

### Generated NAD Example

From the Interface and IPClaim above, nad-fn generates:

```yaml
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: upf-n3
  namespace: upf
spec:
  config: |
    {
      "cniVersion": "0.3.1",
      "type": "macvlan",
      "master": "eth0",
      "mode": "bridge",
      "ipam": {
        "type": "static",
        "addresses": [
          {
            "address": "192.168.252.3/24",
            "gateway": "192.168.252.1"
          }
        ]
      }
    }
```

## Integration with SD-Core Helm Values

After NADs are generated, reference them in your SD-Core Helm values:

```yaml
omec-user-plane:
  enable: true
  config:
    upf:
      access:
        resourceName: "upf-n3"  # Matches NAD name
        ipam: static
        cniPlugin: macvlan
        iface: "eth0"  # Will be set by cluster context
        gateway: "192.168.252.1"
        ip: "192.168.252.3/24"
      
      core:
        resourceName: "upf-n6"
        ipam: static
        cniPlugin: macvlan
        iface: "eth0"
        gateway: "192.168.250.1"
        ip: "192.168.250.3/24"
      
      enb:
        subnet: "192.168.2.0/24"
```

## Kptfile Pipeline Configuration

Your Kptfile should include the interface-fn and nad-fn in the pipeline:

```yaml
apiVersion: kpt.dev/v1
kind: Kptfile
metadata:
  name: upf-package
  annotations:
    config.kubernetes.io/local-config: "true"
pipeline:
  mutators:
  - image: docker.io/nephio/interface-fn:latest
    configMap:
      debug: "true"
  - image: docker.io/nephio/nad-fn:latest
    configMap:
      debug: "true"
  - image: docker.io/nephio/dnn-fn:latest
  validators:
  - image: gcr.io/kpt-fn/kubeval:v0.3.0
    configMap:
      ignore_missing_schemas: "true"
```

## Troubleshooting

### Interface Not Creating IPClaim

**Problem**: Interface resource exists but no IPClaim is created.

**Solutions**:
1. Check that WorkloadCluster resource exists
2. Verify networkInstance.name matches a NetworkInstance resource
3. Check interface-fn logs for errors

```bash
# Check if interface-fn ran
kubectl get events -n upf | grep interface

# View package conditions
kubectl get packagerevision <package-name> -o yaml | grep -A 20 conditions
```

### IPClaim Status Not Populated

**Problem**: IPClaim exists but status is empty.

**Solutions**:
1. Verify IPAM controller is running
2. Check NetworkInstance has IP pools defined
3. Verify IPClaim spec.networkInstance matches NetworkInstance.metadata.name

```bash
# Check IPAM controller
kubectl get pods -n nephio-system | grep ipam

# Check NetworkInstance
kubectl get networkinstance -n upf
```

### NAD Not Generated

**Problem**: Interface and IPClaim exist with status, but no NAD.

**Solutions**:
1. Verify nad-fn is in the Kptfile pipeline
2. Check that IPClaim has status.prefix populated
3. Run the pipeline manually:

```bash
kpt fn render <package-dir>
```

## Best Practices

1. **Use Local Config Annotation**: Always mark Interface resources with `config.kubernetes.io/local-config: "true"` so they don't deploy to clusters

2. **Owner Annotations**: Use `specializer.nephio.org/owner` to track which NF deployment owns the interface

3. **Naming Convention**: Use meaningful names like `n3`, `n6`, `n4` for 5G interfaces

4. **NetworkInstance Abstraction**: Define NetworkInstances separately to enable reuse across multiple NFs

5. **Validate Before Deployment**: Use kpt validators in the pipeline to catch errors early

6. **Version Control**: Keep all Interface and NetworkInstance definitions in your upstream repository

## Complete Workflow Example

1. **Create upstream package with Interface resources**:

```bash
# Clone catalog package
kpt pkg get https://github.com/nephio-project/catalog/workloads/free5gc/upf-bp upf-package

# Add Interface resources
cat > upf-package/interfaces.yaml <<EOF
<paste Interface resources here>
EOF

# Add to git
cd upf-package
git add .
git commit -m "Add Interface definitions"
git push
```

2. **Let Nephio process the package**:
   - PackageVariant controller clones package to workload cluster repo
   - interface-fn runs and creates IPClaim resources
   - IPAM controller allocates IPs and updates IPClaim.status
   - nad-fn reads IPClaim.status and generates NADs

3. **Deploy to cluster**:
   - ConfigSync deploys NADs to workload cluster
   - SD-Core Helm chart references NADs by name
   - Multus attaches interfaces to UPF pod

## References

- [Nephio API Documentation](https://docs.nephio.org/docs/apis/)
- [Interface Function](https://github.com/nephio-project/nephio/tree/main/krm-functions/interface-fn)
- [NAD Function](https://github.com/nephio-project/nephio/tree/main/krm-functions/nad-fn)
- [Multus CNI](https://github.com/k8snetworkplumbingwg/multus-cni)
- [SD-Core Helm Charts](https://github.com/omec-project/sdcore-helm-charts)