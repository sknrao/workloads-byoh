# Complete OAI Monolithic gNB Package Example
# This package contains all resources needed for Nephio-based deployment

---
# interfaces.yaml
# Interface resources for OAI Monolithic gNB

apiVersion: req.nephio.org/v1alpha1
kind: Interface
metadata:
  name: n2
  namespace: oai-ran
  annotations:
    config.kubernetes.io/local-config: "true"
    specializer.nephio.org/owner: req.nephio.org/v1alpha1.NFDeployment.gnb
  labels:
    nephio.org/interface: n2
    nephio.org/nf: gnb
    nephio.org/deployment-type: monolithic
spec:
  networkInstance:
    name: vpc-control
  cniType: macvlan
  attachmentType: vlan

---
apiVersion: req.nephio.org/v1alpha1
kind: Interface
metadata:
  name: n3
  namespace: oai-ran
  annotations:
    config.kubernetes.io/local-config: "true"
    specializer.nephio.org/owner: req.nephio.org/v1alpha1.NFDeployment.gnb
  labels:
    nephio.org/interface: n3
    nephio.org/nf: gnb
    nephio.org/deployment-type: monolithic
spec:
  networkInstance:
    name: vpc-userplane
  cniType: macvlan
  attachmentType: vlan

---
# Optional: RU interface - Set create: true if using Ethernet USRP
apiVersion: req.nephio.org/v1alpha1
kind: Interface
metadata:
  name: ru
  namespace: oai-ran
  annotations:
    config.kubernetes.io/local-config: "true"
    specializer.nephio.org/owner: req.nephio.org/v1alpha1.NFDeployment.gnb
  labels:
    nephio.org/interface: ru
    nephio.org/nf: gnb
    nephio.org/deployment-type: monolithic
spec:
  networkInstance:
    name: vpc-fronthaul
  cniType: macvlan
  attachmentType: vlan

---
# network-instances.yaml
# NetworkInstance resources defining network pools

apiVersion: infra.nephio.org/v1alpha1
kind: NetworkInstance
metadata:
  name: vpc-control
  namespace: oai-ran
  annotations:
    config.kubernetes.io/local-config: "true"
  labels:
    nephio.org/network: control
    nephio.org/nf-type: gnb
spec:
  name: vpc-control
  interfaces:
  - kind: bridgedomain
  - kind: interface
    selector:
      matchLabels:
        nephio.org/interface: n2
  pools:
  - name: n2-ipv4-pool
    prefixLength: 24

---
apiVersion: infra.nephio.org/v1alpha1
kind: NetworkInstance
metadata:
  name: vpc-userplane
  namespace: oai-ran
  annotations:
    config.kubernetes.io/local-config: "true"
  labels:
    nephio.org/network: userplane
    nephio.org/nf-type: gnb
spec:
  name: vpc-userplane
  interfaces:
  - kind: bridgedomain
  - kind: interface
    selector:
      matchLabels:
        nephio.org/interface: n3
  pools:
  - name: n3-ipv4-pool
    prefixLength: 24

---
apiVersion: infra.nephio.org/v1alpha1
kind: NetworkInstance
metadata:
  name: vpc-fronthaul
  namespace: oai-ran
  annotations:
    config.kubernetes.io/local-config: "true"
  labels:
    nephio.org/network: fronthaul
    nephio.org/nf-type: gnb
spec:
  name: vpc-fronthaul
  interfaces:
  - kind: bridgedomain
  - kind: interface
    selector:
      matchLabels:
        nephio.org/interface: ru
  pools:
  - name: ru-ipv4-pool
    prefixLength: 24

---
# workload-cluster.yaml
# WorkloadCluster context information

apiVersion: infra.nephio.org/v1alpha1
kind: WorkloadCluster
metadata:
  name: edge-cluster-1
  namespace: oai-ran
  annotations:
    config.kubernetes.io/local-config: "true"
spec:
  clusterName: edge-cluster-1
  cnis:
  - macvlan
  - sriov
  masterInterface: ens3  # Physical interface for network attachments

---
# package-context.yaml
# Package context for kpt

apiVersion: v1
kind: ConfigMap
metadata:
  name: kptfile.kpt.dev
  annotations:
    config.kubernetes.io/local-config: "true"
data:
  name: gnb-monolithic-edge-cluster-1

---
# Kptfile
# Pipeline configuration with readiness gates

apiVersion: kpt.dev/v1
kind: Kptfile
metadata:
  name: gnb-monolithic-blueprint
  annotations:
    config.kubernetes.io/local-config: "true"
info:
  description: OAI gNB monolithic deployment package with Nephio Interface resources
  
  # Readiness gates ensure package isn't deployed until all conditions are met
  readinessGates:
  # WorkloadCluster injection
  - conditionType: config.injection.WorkloadCluster.workload-cluster
  
  # Interface processing - one per Interface resource
  - conditionType: req.nephio.org.interface.n2
  - conditionType: req.nephio.org.interface.n3
  - conditionType: req.nephio.org.interface.ru
  
  # IP allocation - one per IPClaim (auto-created by interface-fn)
  - conditionType: ipam.nephio.org.ipclaim.n2
  - conditionType: ipam.nephio.org.ipclaim.n3
  - conditionType: ipam.nephio.org.ipclaim.ru

pipeline:
  mutators:
  # interface-fn creates IPClaim resources from Interface resources
  - image: docker.io/nephio/interface-fn:v2.0.0
    configMap:
      debug: "true"
  
  # nad-fn generates NetworkAttachmentDefinitions
  - image: docker.io/nephio/nad-fn:v2.0.0
    configMap:
      debug: "true"
  
  validators:
  # Validate all resources
  - image: gcr.io/kpt-fn/kubeval:v0.3.0
    configMap:
      ignore_missing_schemas: "true"

# NOTE: status section is AUTO-GENERATED by Nephio controllers
# Do NOT manually write the status section in your initial Kptfile

---
# setters.yaml
# Configuration setters for customization

apiVersion: v1
kind: ConfigMap
metadata:
  name: setters
  annotations:
    config.kubernetes.io/local-config: "true"
data:
  cluster-name: edge-cluster-1
  namespace: oai-ran
  master-interface: ens3
  deployment-type: monolithic
